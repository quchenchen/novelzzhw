# 分身系统产品备案文档

**版本号**: v1.3.1
**备案日期**: 2026-01-23
**功能模块**: 身份管理系统 (Identity System)

---

## 1. 功能概述

分身系统允许为单个角色创建多个身份，用于处理卧底、伪装、双重间谍等复杂剧情设定。系统支持时间线感知的身份状态管理，确保剧情发展的逻辑自洽。

### 核心价值

- **多身份管理**: 一个角色可拥有多个身份（真身、公开、隐藏、伪装）
- **时间线感知**: 身份状态随章节变化，支持身份暴露的剧情点记录
- **知晓关系追踪**: 记录哪些角色知道了某个身份，影响剧情互动
- **职业关联**: 每个身份可拥有独立的职业发展路径
- **业务集成**: 与大纲创作、章节生成、分析功能深度集成

---

## 2. 功能规格

### 2.1 身份类型

| 类型 | 代码 | 说明 |
|------|------|------|
| 真身 | `real` | 角色的真实身份，最本质的存在 |
| 公开 | `public` | 大家熟知的公开身份 |
| 隐藏 | `secret` | 只有极少数人知道的秘密身份 |
| 伪装 | `disguise` | 临时使用的伪装身份 |

### 2.2 身份状态

| 状态 | 代码 | 说明 |
|------|------|------|
| 活跃 | `active` | 身份当前有效 |
| 停用 | `inactive` | 身份暂时停用 |
| 已暴露 | `burned` | 身份已被揭露，不再保密 |

### 2.3 主角色段

- 每个角色必须有一个主身份（`is_primary=true`）
- 主身份默认是角色的真身
- 用户可以更改哪个身份是主身份

---

## 3. 用户界面

### 3.1 分身管理页面

**访问路径**: 项目 → 分身设定

**页面布局**:
```
┌─────────────────────────────────────────────────────────┐
│  分身管理                                                  │
├─────────────┬─────────────────────────────────────────────┤
│             │                                             │
│  所有角色    │  [角色名] 的身份                             │
│             │                                             │
│  ├ 角色A    │  [新建身份]                                 │
│  ├ 角色B    │                                             │
│  └ 角色C    │  ┌───────────────┬───────────────────┐      │
│             │  │ 身份1 (主)     │ 身份2 (伪装)      │      │
│             │  │ [真身]         │ [隐藏]            │      │
│             │  │               │                   │      │
│             │  │ 职业 | 谁知晓   │ 职业 | 谁知晓      │      │
│             │  └───────────────┴───────────────────┘      │
└─────────────┴─────────────────────────────────────────────┘
```

### 3.2 身份卡片展示

- **身份名称**: 显示身份的名称
- **类型标签**: 真身/公开/隐藏/伪装
- **主身份标识**: 皇冠图标 + "主身份"标签
- **基本信息**: 外貌、性格、背景
- **操作按钮**: 设为主、编辑、删除
- **标签页**: 职业、谁知晓

### 3.3 角色编辑入口

在角色管理编辑弹窗中添加分身设定入口：
- 显示当前角色的身份数量
- 快捷跳转到分身管理页面

在组织成员编辑中添加分身设定入口：
- 显示该角色在组织中的身份
- 快捷跳转到分身管理页面

---

## 4. 数据模型

### 4.1 Identity 表

```sql
CREATE TABLE identities (
    id VARCHAR PRIMARY KEY,
    project_id VARCHAR NOT NULL,
    character_id VARCHAR NOT NULL,

    -- 身份基本信息
    name VARCHAR NOT NULL,
    identity_type VARCHAR NOT NULL,  -- real/public/secret/disguise
    is_primary BOOLEAN DEFAULT FALSE,
    status VARCHAR DEFAULT 'active',   -- active/inactive/burned

    -- 外貌与性格
    appearance TEXT,
    personality TEXT,
    background TEXT,
    voice_style TEXT,

    -- 时间线感知
    exposed_at_chapter INTEGER,       -- 在第几章暴露

    -- 时间戳
    created_at TIMESTAMP,
    updated_at TIMESTAMP,

    -- 外键约束
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (character_id) REFERENCES characters(id)
);
```

### 4.2 IdentityCareer 表

```sql
CREATE TABLE identity_careers (
    id VARCHAR PRIMARY KEY,
    identity_id VARCHAR NOT NULL,
    career_id VARCHAR NOT NULL,
    career_type VARCHAR NOT NULL,      -- main/sub
    current_stage INTEGER DEFAULT 1,
    stage_progress INTEGER DEFAULT 0,

    FOREIGN KEY (identity_id) REFERENCES identities(id),
    FOREIGN KEY (career_id) REFERENCES careers(id)
);
```

### 4.3 IdentityKnowledge 表

```sql
CREATE TABLE identity_knowledge (
    id VARCHAR PRIMARY KEY,
    identity_id VARCHAR NOT NULL,
    knower_character_id VARCHAR NOT NULL,

    knowledge_level VARCHAR,           -- full/partial/suspected
    how_discovered TEXT,
    when_discovered TIMESTAMP,
    is_secret BOOLEAN DEFAULT TRUE,
    notes TEXT,

    FOREIGN KEY (identity_id) REFERENCES identities(id),
    FOREIGN KEY (knower_character_id) REFERENCES characters(id)
);
```

### 4.4 唯一性约束

```sql
-- 组织成员关系唯一性（同一角色的同一身份不能重复加入同一组织）
CREATE UNIQUE INDEX idx_org_member_identity_unique
ON organization_members(organization_id, character_id, identity_id)
WHERE identity_id IS NOT NULL;
```

---

## 5. API 接口

### 5.1 身份 CRUD

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/identities/project/{project_id}` | 获取项目所有身份 |
| GET | `/api/identities/character/{character_id}` | 获取角色的所有身份 |
| GET | `/api/identities/{identity_id}` | 获取身份详情 |
| POST | `/api/identities` | 创建新身份 |
| PUT | `/api/identities/{identity_id}` | 更新身份 |
| DELETE | `/api/identities/{identity_id}` | 删除身份 |
| PUT | `/api/identities/{identity_id}/set-primary` | 设为主身份 |

### 5.2 身份职业

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/identities/{identity_id}/careers` | 获取身份的职业列表 |
| POST | `/api/identities/{identity_id}/careers` | 添加身份职业 |
| PUT | `/api/identities/{identity_id}/careers/{career_id}` | 更新职业阶段 |
| DELETE | `/api/identities/{identity_id}/careers/{career_id}` | 删除身份职业 |

### 5.3 认知关系

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/identities/{identity_id}/knowledge` | 获取谁知晓该身份 |
| POST | `/api/identities/{identity_id}/knowledge` | 添加认知关系 |
| PUT | `/api/identities/{identity_id}/knowledge/{knowledge_id}` | 更新认知关系 |
| DELETE | `/api/identities/{identity_id}/knowledge/{knowledge_id}` | 删除认知关系 |

---

## 6. 业务集成

### 6.1 章节生成

身份信息通过 `ChapterContextBuilder._build_character_identities()` 方法注入到章节生成上下文中：

```python
# 输出示例：
【角色身份信息 - 智能过滤】

角色：林默
  - 林默 [真身, 主身份]
  - 陈风 [公开] | 职业: 自由职业者
  - 毒蛇 [隐藏, 需保密] | 职业: 军统杀手 | 被知晓: 局长(完全知晓) ✓

角色：王霸道
  - 王霸道 [真身, 主身份]
```

### 6.2 角色生成

AI 生成角色时会创建 `identities` 字段：

```json
{
  "name": "林默",
  "identities": [
    {
      "name": "林默",
      "identity_type": "real",
      "is_primary": true,
      "status": "active"
    },
    {
      "name": "陈风",
      "identity_type": "disguise",
      "is_primary": false,
      "status": "active",
      "background": "伪装成普通自由职业者"
    },
    {
      "name": "毒蛇",
      "identity_type": "secret",
      "is_primary": false,
      "status": "active",
      "background": "军统卧底代号"
    }
  ]
}
```

### 6.3 章节分析

章节分析会识别 `identity_exposures`：

```json
{
  "identity_exposures": [
    {
      "character_name": "林默",
      "exposed_identity_name": "毒蛇",
      "exposure_type": "disguise_broken",
      "exposure_context": "在战斗中面具被击落",
      "witnesses": ["王霸道"],
      "impact_on_organization": "可能被追杀"
    }
  ]
}
```

---

## 7. 使用场景示例

### 场景一：卧底题材

```
角色：林默
├── 真身 (real) - 林默，国安局特工
├── 伪装 (disguise) - 陈风，自由职业者
└── 隐藏 (secret) - 毒蛇，军统杀手

剧情发展：
- 第1章：以"陈风"身份接触目标组织
- 第5章：以"毒蛇"身份加入组织核心
- 第10章："陈风"身份被怀疑，让其"死亡"
- 第15章："毒蛇"真实身份暴露
```

### 场景二：复仇伪装

```
角色：张三
├── 真身 (real) - 张三，复仇者
├── 伪装 (disguise) - 李四，整容后的新身份
└── 隐藏 (secret) - 暗夜使者，真实身份

剧情发展：
- 第1章：以"李四"身份接近仇人
- 第8章：逐步暴露"暗夜使者"的线索
- 第12章：真实身份揭晓
```

### 场景三：家族秘密

```
角色：王五
├── 真身 (real) - 王五，家族弃子
├── 公开 (public) - 王五，普通商人
└── 隐藏 (secret) - 龙门少主，真实身份

剧情发展：
- 第1章：不知道自己身份
- 第5章：逐步发现线索
- 第10章：身份完全揭露，承担家族责任
```

---

## 8. 技术特性

### 8.1 时间线感知

系统根据章节号计算身份的当时状态：

```python
class Identity:
    def is_exposed_at_chapter(self, chapter_number: int) -> bool:
        """判断在指定章节时身份是否已暴露"""
        if self.exposed_at_chapter is None:
            return False
        return chapter_number >= self.exposed_at_chapter

    def get_status_at_chapter(self, chapter_number: int) -> str:
        """获取身份在指定章节时的状态"""
        if self.exposed_at_chapter is None:
            return self.status
        return "burned" if chapter_number >= self.exposed_at_chapter else "active"
```

### 8.2 智能过滤

章节生成时只显示相关角色的身份信息：
- 提取大纲/扩展计划中的角色列表
- 只包含这些角色的身份
- 过滤掉不重要的默认身份

### 8.3 知晓关系追踪

记录哪些角色知道了某个身份：
- `full` - 完全知晓
- `partial` - 部分知晓
- `suspected` - 有怀疑

---

## 9. 产品截图

### 9.1 分身管理页面

```
┌──────────────────────────────────────────────────────────┐
│  👤 分身管理                                               │
│  为角色创建多个身份，用于卧底、伪装等复杂剧情设定          │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ┌─────────────┐  ┌──────────────────────────────────┐   │
│  │ 所有角色     │  │ 林默 的身份                      │   │
│  │             │  │                                  │   │
│  │ 林默  3个   │  │  [新建身份]                       │   │
│  │ 王霸道 2个  │  │                                  │   │
│  │ 影刃  1个   │  │  ┌───────────┬─────────────┐     │   │
│  │             │  │  │林默(主)   │陈风(伪装)  │     │   │
│  │             │  │  │👑真身     │隐藏        │     │   │
│  │             │  │  │           │🎭需保密    │     │   │
│  │             │  │  │职业 |知晓  │职业 |知晓  │     │   │
│  │             │  │  └───────────┴─────────────┘     │   │
│  │             │  │                                  │   │
│  └─────────────┘  └──────────────────────────────────┘   │
└──────────────────────────────────────────────────────────┘
```

### 9.2 身份详情卡片

```
┌────────────────────────────────────┐
│ 👑 林默         [真身] [主身份]    │
│                                    │
│ 外貌：30岁左右，身材精瘦，眼神锐利  │
│ 性格：冷静、机智、多疑               │
│                                    │
│ 【职业】谁知晓                      │
└────────────────────────────────────┘
```

---

## 10. 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.3.1 | 2026-01-23 | 初始版本，包含完整的分身系统功能 |
| v1.3.0 | 2026-01-22 | 基础架构搭建 |

---

## 11. 已知限制

1. **时间线编辑**: 暂不支持直接在界面上编辑身份的暴露时间点，需要通过分析章节触发
2. **批量操作**: 暂不支持批量创建或修改身份
3. **身份继承**: 暂不支持角色间共享身份

---

## 12. 后续规划

1. **时间线可视化**: 在时间线视图中显示身份变化
2. **冲突检测**: 检测身份使用场景的逻辑冲突
3. **智能建议**: 根据剧情发展建议身份使用策略
4. **导出功能**: 导出身份关系图和剧情时间线

---

**文档维护**: 产品部
**技术支持**: 开发部
**最后更新**: 2026-01-23
