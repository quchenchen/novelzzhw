# 分身系统技术实现文档

**版本号**: v1.3.1
**技术负责人**: 开发部
**最后更新**: 2026-01-23

---

## 1. 架构设计

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ Identities.tsx│  │IdentityForm  │  │IdentityCareer│        │
│  │   (列表页)   │  │  (表单组件)   │  │    Card      │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│         │                   │                  │              │
│         └───────────────────┴──────────────────┘              │
│                             │                                │
└─────────────────────────────┼────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        API层                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  /api/identities/*                                    │   │
│  │    - CRUD 操作                                         │   │
│  │    - 职业管理 (/careers)                              │   │
│  │    - 认知关系 (/knowledge)                            │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────┬────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        服务层                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  identity_service.py                                  │   │
│  │    - get_identities_by_project()                      │   │
│  │    - get_identities_by_character()                     │   │
│  │    - create_identity()                                │   │
│  │    - update_identity()                                │   │
│  │    - delete_identity()                                │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  chapter_context_service.py                           │   │
│  │    - _build_character_identities()                    │   │
│  │    - 时间线感知状态计算                               │   │
│  │    - 知晓关系查询                                     │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────┬────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        数据层                               │
│  ┌──────────────┐  ┌──────────────────┐  ┌──────────────┐   │
│  │   Identity   │  │ IdentityCareer  │  │IdentityKnowledge  │   │
│  │   (身份)     │  │   (身份职业)    │  │  (认知关系)      │   │
│  └──────────────┘  └──────────────────┘  └──────────────┘   │
│         │                   │                    │          │
│         └───────────────────┴────────────────────          │
│                             ▼                               │
│  ┌──────────────┐  ┌──────────────────┐  ┌──────────────┐   │
│  │  Character   │  │     Career      │  │  Character   │   │
│  │   (角色)     │  │    (职业)       │  │  (角色)      │   │
│  └──────────────┘  └──────────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 核心模型

### 2.1 Identity 模型

**文件**: `app/models/identity.py`

```python
class Identity(Base):
    __tablename__ = "identities"

    # 主键
    id = Column(String, primary_key=True, default=lambda: generate_unique_id())

    # 外键
    project_id = Column(String, ForeignKey("projects.id"), nullable=False)
    character_id = Column(String, ForeignKey("characters.id"), nullable=False)

    # 身份基本信息
    name = Column(String(100), nullable=False)
    identity_type = Column(Enum("real", "public", "secret", "disguise"), nullable=False)
    is_primary = Column(Boolean, default=False)
    status = Column(Enum("active", "inactive", "burned"), default="active")

    # 外貌与性格
    appearance = Column(Text)
    personality = Column(Text)
    background = Column(Text)
    voice_style = Column(String(100))

    # 时间线感知
    exposed_at_chapter = Column(Integer, comment="在第几章暴露")

    # 时间戳
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())

    def is_exposed_at_chapter(self, chapter_number: int) -> bool:
        """判断在指定章节时身份是否已暴露"""
        if self.exposed_at_chapter is None:
            return False
        return chapter_number >= self.exposed_at_chapter

    def get_status_at_chapter(self, chapter_number: int) -> str:
        """获取身份在指定章节时的状态"""
        if self.exposed_at_chapter is None:
            return self.status
        return "burned" if chapter_number >= self.exposed_at_chapter else "active"
```

### 2.2 IdentityCareer 模型

**文件**: `app/models/identity_career.py`

```python
class IdentityCareer(Base):
    __tablename__ = "identity_careers"

    id = Column(String, primary_key=True, default=lambda: generate_unique_id())
    identity_id = Column(String, ForeignKey("identities.id"), nullable=False)
    career_id = Column(String, ForeignKey("careers.id"), nullable=False)
    career_type = Column(Enum("main", "sub"), nullable=False)
    current_stage = Column(Integer, default=1)
    stage_progress = Column(Integer, default=0)
    created_at = Column(DateTime, server_default=func.now())
```

### 2.3 IdentityKnowledge 模型

**文件**: `app/models/identity_knowledge.py`

```python
class IdentityKnowledge(Base):
    __tablename__ = "identity_knowledge"

    id = Column(String, primary_key=True, default=lambda: generate_unique_id())
    identity_id = Column(String, ForeignKey("identities.id"), nullable=False)
    knower_character_id = Column(String, ForeignKey("characters.id"), nullable=False)

    knowledge_level = Column(Enum("full", "partial", "suspected"), default="partial")
    how_discovered = Column(Text)
    when_discovered = Column(DateTime)
    is_secret = Column(Boolean, default=True)
    notes = Column(Text)

    created_at = Column(DateTime, server_default=func.now())
```

---

## 3. API 端点实现

### 3.1 获取角色的所有身份

**文件**: `app/api/identities.py`

```python
@router.get("/character/{character_id}",
           response_model=List[IdentityResponse],
           summary="获取角色的所有身份")
async def get_character_identities(
    character_id: str,
    request: Request,
    db: AsyncSession = Depends(get_db)
):
    """获取指定角色的所有身份 - 主身份排在前面"""
    character_result = await db.execute(
        select(Character).where(Character.id == character_id)
    )
    character = character_result.scalar_one_or_none()
    if not character:
        raise HTTPException(status_code=404, detail="角色不存在")

    # 验证项目权限
    user_id = get_user_id(request)
    await verify_project_access(character.project_id, user_id, db)

    identities = await identity_service.get_identities_by_character(character_id, db)
    return identities
```

### 3.2 创建身份

```python
@router.post("", response_model=IdentityResponse, summary="创建身份")
async def create_identity(
    identity_data: IdentityCreate,
    request: Request,
    db: AsyncSession = Depends(get_db)
):
    """创建新身份"""
    user_id = get_user_id(request)
    if not user_id:
        raise HTTPException(status_code=401, detail="未登录")

    # 获取角色以确定项目ID
    character_result = await db.execute(
        select(Character).where(Character.id == identity_data.character_id)
    )
    character = character_result.scalar_one_or_none()
    if not character:
        raise HTTPException(status_code=404, detail="角色不存在")

    # 验证项目权限
    await verify_project_access(character.project_id, user_id, db)

    try:
        identity = await identity_service.create_identity(
            project_id=character.project_id,
            identity_data=identity_data,
            db=db
        )
        await db.commit()
        await db.refresh(identity)
        return identity
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
```

---

## 4. 业务逻辑集成

### 4.1 章节生成上下文构建

**文件**: `app/services/chapter_context_service.py`

```python
async def _build_character_identities(
    self,
    chapter: Chapter,
    project: Project,
    db: AsyncSession
) -> Optional[str]:
    """
    构建本章涉及角色的身份信息

    新增功能：
    1. 智能过滤：只包含本章相关的身份信息
    2. 状态感知：根据剧情进度过滤已暴露/未暴露身份
    3. 关系提示：提醒作者谁知道了哪些身份
    """
    # 获取本章相关角色
    filter_character_names = self._get_chapter_characters(chapter, project)

    # 获取角色并筛选
    characters_result = await db.execute(
        select(Character).where(Character.project_id == project.id)
    )
    characters = characters_result.scalars().all()

    if filter_character_names:
        characters = [c for c in characters if c.name in filter_character_names]

    # 构建身份信息
    identity_lines = []
    identity_lines.append("【角色身份信息 - 智能过滤】")

    for character in characters[:8]:
        # 获取角色的所有身份
        identities_result = await db.execute(
            select(Identity).where(
                Identity.character_id == character.id
            ).order_by(Identity.is_primary.desc(), Identity.created_at.asc())
        )
        identities = identities_result.scalars().all()

        if not identities:
            continue

        # 跳过只有默认主身份的情况
        active_identities = [i for i in identities if i.status == 'active']
        if len(identities) == 1 and identities[0].is_primary:
            continue

        identity_lines.append(f"\n角色：{character.name}")

        for identity in identities:
            # 时间线感知
            is_exposed = identity.is_exposed_at_chapter(chapter.chapter_number)
            status_at_chapter = identity.get_status_at_chapter(chapter.chapter_number)

            # 知晓关系
            knowledge_result = await db.execute(
                select(IdentityKnowledge).where(
                    IdentityKnowledge.identity_id == identity.id
                )
            )
            knowledge_list = knowledge_result.scalars().all()

            # 格式化输出
            identity_lines.append(
                f"  - {identity.name} [{type_label}, {status_at_chapter}]"
            )

    return "\n".join(identity_lines) if len(identity_lines) > 1 else None
```

---

## 5. 前端组件

### 5.1 Identities.tsx

**文件**: `frontend/src/pages/Identities.tsx`

**核心功能**:
1. 显示项目所有角色
2. 显示每个角色的身份列表
3. 创建/编辑/删除身份
4. 设为主身份
5. 身份卡片展示（职业、谁知晓标签页）

### 5.2 IdentityForm.tsx

**文件**: `frontend/src/components/identity/IdentityForm.tsx`

**功能**:
- 创建/编辑身份的表单对话框
- 身份类型选择（真身/公开/隐藏/伪装）
- 主身份开关
- 外貌、性格、背景输入

### 5.3 IdentityCareerCard.tsx

**文件**: `frontend/src/components/identity/IdentityCareerCard.tsx`

**功能**:
- 显示身份的职业信息
- 添加/删除职业
- 更新职业阶段

### 5.4 IdentityKnowledgeList.tsx

**文件**: `frontend/src/components/identity/IdentityKnowledgeList.tsx`

**功能**:
- 显示谁知道了该身份
- 添加/删除认知关系
- 设置知晓程度（完全/部分/怀疑）

---

## 6. 数据库迁移

### 6.1 创建身份表

**迁移文件**: `alembic/postgres/versions/xxxxx_create_identities.py`

```python
def upgrade():
    # 创建 identities 表
    op.create_table(
        'identities',
        sa.Column('id', sa.String(), nullable=False),
        sa.Column('project_id', sa.String(), nullable=False),
        sa.Column('character_id', sa.String(), nullable=False),
        sa.Column('name', sa.String(100), nullable=False),
        sa.Column('identity_type', sa.Enum('real', 'public', 'secret', 'disguise'), nullable=False),
        sa.Column('is_primary', sa.Boolean(), default=False),
        sa.Column('status', sa.Enum('active', 'inactive', 'burned'), default='active'),
        sa.Column('appearance', sa.Text(), nullable=True),
        sa.Column('personality', sa.Text(), nullable=True),
        sa.Column('background', sa.Text(), nullable=True),
        sa.Column('voice_style', sa.String(100), nullable=True),
        sa.Column('exposed_at_chapter', sa.Integer(), nullable=True),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ),
        sa.ForeignKeyConstraint(['character_id'], ['characters.id'], ),
        sa.PrimaryKeyConstraint('id')
    )
```

---

## 7. 部署说明

### 7.1 环境要求

- Python 3.11+
- PostgreSQL 13+
- Node.js 20+

### 7.2 部署步骤

1. **数据库迁移**:
```bash
cd backend
alembic upgrade head
```

2. **后端启动**:
```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

3. **前端构建**:
```bash
cd frontend
pnpm run build
```

4. **静态文件部署**:
```bash
# 将 frontend/dist/* 复制到 backend/static/
```

---

## 8. 测试

### 8.1 单元测试

**文件**: `tests/test_models/test_identity.py`

```python
async def test_identity_is_exposed_at_chapter():
    """测试时间线感知方法"""
    identity = Identity(
        exposed_at_chapter=5,
        status="active"
    )

    assert not identity.is_exposed_at_chapter(4)
    assert identity.is_exposed_at_chapter(5)
    assert identity.is_exposed_at_chapter(10)

    assert identity.get_status_at_chapter(4) == "active"
    assert identity.get_status_at_chapter(5) == "burned"
```

### 8.2 集成测试

**文件**: `tests/test_api/test_identities.py`

```python
async def test_create_identity(client, auth_headers):
    """测试创建身份"""
    response = await client.post(
        "/api/identities",
        json={
            "character_id": "char_001",
            "name": "测试身份",
            "identity_type": "secret",
            "is_primary": False
        },
        headers=auth_headers
    )
    assert response.status_code == 200
    data = response.json()
    assert data["name"] == "测试身份"
```

---

## 9. 故障排查

### 9.1 常见问题

**Q: 角色列表显示"获取角色身份失败: TypeError: x.map is not a function"**

A: API 返回 `{total, items}` 结构，前端需要使用 `.items || []` 来处理

**Q: 身份信息没有出现在章节生成中**

A: 检查 `ChapterContextBuilder._build_character_identities()` 是否被正确调用

**Q: 时间线状态不正确**

A: 确保 `exposed_at_chapter` 字段被正确设置

### 9.2 日志位置

- 后端日志: `logs/mumuainovel-zzhw.log`
- 前端日志: 浏览器开发者工具控制台
- 数据库日志: PostgreSQL 日志

---

**文档维护**: 开发部
**技术支持**: support@example.com
**最后更新**: 2026-01-23
